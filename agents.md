# SounnyPDF Form Filler WebApp - Agent Handoff

## Project Overview
This project is a 100% client-side, purely browser-based interactive PDF Form Filler and Document Signer WebApp. The user can upload a PDF locally into their browser, add resizable text blocks, signs with a trackpad-drawn signature, add standard form-filling symbols (checkmarks, X marks, circles), zoom in/out, and instantly redownload the rendered PDF document. **ZERO data is collected or sent to a server; everything is completely local and private.**

## GitHub Repository
`https://github.com/sounny/pdf`

## Key Packages & Tooling
*   **pdf.js (CDN)**: Extracts and renders the PDF buffer to standard HTML5 `<canvas>` elements for user viewing.
*   **pdf-lib (NPM/via Webpack or direct unpkg URL)**: Intersects and manipulates the PDF document blob directly by rendering user input overlay coordinates as fixed PDF data chunks on save.

## Milestones Accomplished (Latest Changes)
During this recent session, the agent addressed the following upgrades to this project:
*   Added an auto-zoom capability natively within `script.js` that scales an uploaded PDF's default `viewport.scale` to immediately fill the length of the window screen.
*   Added zoom-in (+) and zoom-out (-) capabilities.
*   Added 'Fit Width' and 'Fit Page' zoom configuration endpoints in the top bar.
*   Patched an encoding crash generated by `pdf-lib` not correctly registering unicode Checkmarks (✔), Xs (✘), and Radio Circles (●) by forcing the tool to construct its output layers explicitly using the `StandardFonts.ZapfDingbats` library. 
*   Added an SVG mobile hamburger `actionsMenu` dropdown in `style.css` so tools no longer squish or bleed offscreen on mobile formats.
*   Cleaned and refactored the design: Upgraded the central `H1` upload screen with a customized UI tag line `"SounnyPDF Form Filler WebApp"`, generated and embedded a brand new vector `sounnypdf_icon.png` application icon logo, linked the internal Sounny repo in the footer, and adjusted UI element button visibility logic.
*   **Color Picker Toolbar**: Added a new toolbar feature allowing users to change the color of text and marker symbols. The UI consists of an 8-hex-color palette. The `script.js` logic applies the `currentColor` state to actively selected HTML DOM elements, and the `pdf-lib` save function was overhauled to dynamically extract the `element.style.color` values and parse them to `rgb()` format before rendering the final layer so that the downloaded PDF correctly persists the custom colors.
*   **Zoom & Annotation Preservation Fix**: Fixed a critical bug where zooming wiped out all user-added text and signatures. The system now caches annotations, re-renders the PDF at the new scale, and then re-applies the annotations with proportional coordinate and font-size scaling.
*   **Dynamic Zoom Calculations**: Rewrote "Fit Width" and "Fit Page" to dynamically recalculate based on the current viewport and window dimensions instead of using stale initial values.
*   **Toolbar Upload Button**: Replaced the static instruction text with a functional "Upload PDF" button in the navbar for easier workspace management.
*   **Text Save Bug Fix**: Fixed critical bug where paragraphs went off-page in saved PDFs. Root cause was a 1.25x font multiplier inflating PDF font size beyond what was visible on screen. Also fixed `extractTextSafely` which was reading from the wrapper div (accidentally including delete button text) instead of the `.text-content` child.
*   **Drawable Text Box Tool**: Added a new "Draw Text Box" button that toggles crosshair draw mode. Users click and drag to create a text box of any size. Text boxes are resizable (via corner handle like signatures) and support all existing features (color, font size, dragging, editing, saving).
*   **Undo/Redo System**: Implemented a comprehensive history stack that tracks "add", "remove", and "move" (drag) actions with a 50-entry limit. Included UI buttons and standard keyboard shortcuts (Ctrl+Z / Ctrl+Y).
*   **Highlight / Annotation Tool**: Added a "Highlight" tool that allows users to draw semi-transparent rectangles over the PDF. Uses `mix-blend-mode: multiply` for a realistic highlighter effect on screen and `pdfPage.drawRectangle` with opacity for the saved PDF.
*   **Collapsible Color Picker**: Overhauled the color picker UI into a collapsible dropdown panel to save vertical toolbar space. The toggle button displays the currently selected color.
*   **General Bug Fixes**: Updated all active-element selectors and zoom preservation logic to include `.draggable-textbox` and `.draggable-highlight`. Fixed outside-click exclusion lists. Extracted `parseColorToRgb()` as a reusable helper in the save function. Added `maxWidth` constraint to `drawText()` for textboxes.

## Known Architecture Implementation Details
Because standard Helvetica font files utilized by `pdf-lib` do not support drawing Emoji characters native to Windows/MacOS environments onto raw PDFs, the tool's character mapping was refactored. The script now dynamically swaps between generic Helvetica fonts and specialized `ZapfDingbats` encoding layers based entirely on whether the specific character being generated matches `['✔', '✘', '●']`.

If a future update introduces more symbols, please remember to adjust the `script.js` > `pdfPage.drawText()` `fontToUse` dictionary so you do not encounter `"WinAnsi cannot encode <char>"` hex-conversion crashes during the raw buffer file export function.

When extracting the color from HTML elements for `pdf-lib` to save the PDF, `element.style.color` returns strings in various formats (e.g., `#D32F2F` or `rgb(211, 47, 47)`). The logic uses regex matching to parse these formats into fractional RGB values between `0` and `1` (which `pdf-lib` requires).

The **Zoom Preservation** logic in `renderPDF` works by:
1. Scanning all `.pdf-page-wrapper` elements for `.draggable-text`, `.draggable-signature`, `.draggable-textbox`, and `.draggable-highlight` before clearing the page.
2. Storing clones of these nodes along with their original container widths.
3. After the new page is rendered, calculating a `scaleRatio` (`newWidth / oldWidth`).
4. Re-scaling `top`, `left`, `font-size` (for text), and `height` (for images) by the ratio before re-appending them to the new wrappers.
5. Re-binding all event listeners (draggable, delete, dblclick, color changes) to the new nodes.
